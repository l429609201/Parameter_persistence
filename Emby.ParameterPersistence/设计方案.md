# EMBY 参数持久化插件设计方案

## 一、插件基本信息

- **插件名称**: Emby.ParameterPersistence
- **中文名称**: 参数持久化
- **分类**: 高级 (Advanced)
- **版本**: 2.0.0
- **描述**: 提供参数持久化API，支持将参数存储在本地JSON文件中，统一的接口设计支持单个和批量操作

## 二、核心功能

### 2.1 功能列表
1. **参数查询**: 统一接口支持单个、批量、命名空间查询
2. **参数创建**: 统一接口支持单个和批量创建
3. **参数更新**: 统一接口支持单个和批量更新
4. **参数删除**: 统一接口支持单个和批量删除
5. **参数列表**: 获取所有参数，支持筛选和搜索
6. **命名空间分类**: 支持按命名空间组织参数
7. **Web界面**: 提供可视化管理界面

### 2.2 存储方案
- **存储位置**: `{ApplicationPaths.PluginConfigurationsPath}/ParameterPersistence/`
- **文件格式**: JSON
- **文件命名**: `parameters.json`
- **数据结构**:
```json
{
  "parameters": [
    {
      "id": "uuid",
      "namespace": "plugin.name",
      "key": "setting_key",
      "value": "setting_value",
      "type": "string",
      "description": "参数描述",
      "createdAt": "2026-02-27T19:00:00Z",
      "updatedAt": "2026-02-27T19:00:00Z"
    }
  ]
}
```

## 三、技术架构

### 3.1 项目结构
```
Emby.ParameterPersistence/
├── Plugin.cs                              # 插件主类
├── Configuration/
│   ├── PluginConfiguration.cs             # 插件配置类
│   └── configPage.html                    # 配置页面
├── Api/
│   └── ParameterController.cs             # API控制器
├── Models/
│   ├── ParameterModel.cs                  # 参数模型
│   └── ParameterResponse.cs               # API响应模型
├── Services/
│   ├── IParameterStorageService.cs        # 存储服务接口
│   └── ParameterStorageService.cs         # 存储服务实现
└── Emby.ParameterPersistence.csproj       # 项目文件
```

### 3.2 技术栈
- **开发语言**: C# (.NET Framework 4.6.2 或 .NET Standard 2.0)
- **依赖框架**: MediaBrowser.Common, MediaBrowser.Controller, MediaBrowser.Model
- **前端技术**: HTML5 + JavaScript + CSS
- **数据格式**: JSON

## 四、API接口设计

### 4.1 设计理念

#### 4.1.1 统一的请求方式
- **除List外，其他接口都使用POST方法**
- 避免使用路径参数（如 `/{namespace}/{key}`）
- 所有参数通过请求体传递，更灵活

#### 4.1.2 自动识别单个/批量
- 通过请求体结构自动判断操作类型
- 单个操作：提供 `key` 字段
- 批量操作：提供 `keys` 或 `parameters` 字段

#### 4.1.3 一致的响应格式
- 单个操作：使用 `data` 字段返回单个对象
- 批量操作：使用 `dataList` 字段返回数组
- 统一的错误处理：`success` + `message`

#### 4.1.4 语义化的路径
- `/Query` - 查询操作
- `/Create` - 创建操作
- `/Update` - 更新操作
- `/Delete` - 删除操作

### 4.2 接口总览

本插件提供 **5个API接口**：

| 接口名称 | 路径 | 方法 | 功能 |
|---------|------|------|------|
| Query | `/Parameters/Query` | POST | 查询参数（单个/批量/命名空间） |
| Create | `/Parameters/Create` | POST | 创建参数（单个/批量） |
| Update | `/Parameters/Update` | POST | 更新参数（单个/批量） |
| Delete | `/Parameters/Delete` | POST | 删除参数（单个/批量） |
| List | `/Parameters` | GET | 列出所有参数（支持筛选） |

### 4.3 查询参数接口 - Query

**接口地址**: `POST /emby/ParameterPersistence/Parameters/Query`

**功能**: 查询参数，自动识别单个、批量或命名空间查询

**请求格式**:

```json
// 单个参数查询
{
  "namespace": "MyPlugin",
  "key": "ApiKey"
}

// 批量参数查询
{
  "namespace": "MyPlugin",
  "keys": ["ApiKey", "ApiSecret", "BaseUrl"]
}

// 查询整个命名空间
{
  "namespace": "MyPlugin"
}
```

**响应格式**:

```json
// 单个参数（有key字段时）
{
  "success": true,
  "data": {
    "id": "uuid",
    "namespace": "MyPlugin",
    "key": "ApiKey",
    "value": "abc123",
    "type": "string",
    "description": "API密钥",
    "createdAt": "2026-02-27T19:00:00Z",
    "updatedAt": "2026-02-27T19:00:00Z"
  }
}

// 批量参数（有keys字段或只有namespace时）
{
  "success": true,
  "dataList": [
    {"namespace": "MyPlugin", "key": "ApiKey", "value": "abc123"},
    {"namespace": "MyPlugin", "key": "ApiSecret", "value": "secret456"}
  ],
  "total": 2
}
```

### 4.4 创建参数接口 - Create

**接口地址**: `POST /emby/ParameterPersistence/Parameters/Create`

**功能**: 创建参数，自动识别单个或批量创建

**请求格式**:

```json
// 单个参数创建
{
  "namespace": "MyPlugin",
  "key": "ApiKey",
  "value": "abc123",
  "type": "string",
  "description": "API密钥"
}

// 批量参数创建
{
  "parameters": [
    {"namespace": "MyPlugin", "key": "ApiKey", "value": "abc123", "type": "string"},
    {"namespace": "MyPlugin", "key": "ApiSecret", "value": "secret456"}
  ]
}
```

**响应格式**:

```json
// 单个创建
{
  "success": true,
  "data": {"namespace": "MyPlugin", "key": "ApiKey", "value": "abc123"},
  "message": "参数创建成功"
}

// 批量创建
{
  "success": true,
  "dataList": [...],
  "total": 2,
  "message": "成功创建 2 个参数"
}
```

### 4.5 更新参数接口 - Update

**接口地址**: `POST /emby/ParameterPersistence/Parameters/Update`

**功能**: 更新参数，自动识别单个或批量更新

**请求格式**:

```json
// 单个参数更新
{
  "namespace": "MyPlugin",
  "key": "ApiKey",
  "value": "new_value",
  "description": "更新后的描述"
}

// 批量参数更新
{
  "parameters": [
    {"namespace": "MyPlugin", "key": "ApiKey", "value": "new_value1"},
    {"namespace": "MyPlugin", "key": "ApiSecret", "value": "new_value2"}
  ]
}
```

**响应格式**:

```json
// 单个更新
{
  "success": true,
  "data": {"namespace": "MyPlugin", "key": "ApiKey", "value": "new_value"},
  "message": "参数更新成功"
}

// 批量更新
{
  "success": true,
  "dataList": [...],
  "total": 2,
  "message": "成功更新 2 个参数"
}
```

### 4.6 删除参数接口 - Delete

**接口地址**: `POST /emby/ParameterPersistence/Parameters/Delete`

**功能**: 删除参数，自动识别单个或批量删除

**请求格式**:

```json
// 单个参数删除
{
  "namespace": "MyPlugin",
  "key": "ApiKey"
}

// 批量删除（简化方式-同一命名空间）
{
  "namespace": "MyPlugin",
  "keys": ["ApiKey", "ApiSecret", "BaseUrl"]
}

// 批量删除（完整方式-不同命名空间）
{
  "parameters": [
    {"namespace": "PluginA", "key": "ApiKey"},
    {"namespace": "PluginB", "key": "ApiSecret"}
  ]
}
```

**响应格式**:

```json
// 单个删除
{
  "success": true,
  "message": "参数删除成功"
}

// 批量删除
{
  "success": true,
  "total": 3,
  "message": "成功删除 3 个参数"
}
```

### 4.7 列出参数接口 - List

**接口地址**: `GET /emby/ParameterPersistence/Parameters`

**功能**: 获取所有参数，支持筛选和搜索

**查询参数**:
- `namespace`: 按命名空间筛选（可选）
- `keyword`: 搜索关键词（可选）
- `X-Emby-Token`: EMBY Token（必填）

**请求示例**:
```bash
GET /emby/ParameterPersistence/Parameters?X-Emby-Token=xxx
GET /emby/ParameterPersistence/Parameters?namespace=MyPlugin&X-Emby-Token=xxx
GET /emby/ParameterPersistence/Parameters?keyword=api&X-Emby-Token=xxx
```

**响应格式**:
```json
{
  "success": true,
  "dataList": [
    {
      "id": "uuid",
      "namespace": "MyPlugin",
      "key": "ApiKey",
      "value": "abc123",
      "type": "string",
      "description": "API密钥",
      "createdAt": "2026-02-27T19:00:00Z",
      "updatedAt": "2026-02-27T19:00:00Z"
    }
  ],
  "total": 1
}
```

## 五、Web管理界面设计

### 5.1 界面布局
```
+--------------------------------------------------+
|  参数持久化管理                                      |
+--------------------------------------------------+
|  [搜索框]  [命名空间筛选]  [+ 新增参数]              |
+--------------------------------------------------+
|  命名空间    |  键名    |  值    |  类型  |  操作   |
+--------------------------------------------------+
|  plugin.a   |  key1   | val1  | string | 编辑 删除|
|  plugin.a   |  key2   | val2  | number | 编辑 删除|
|  plugin.b   |  key3   | val3  | json   | 编辑 删除|
+--------------------------------------------------+
|  总计: 3 个参数                                     |
+--------------------------------------------------+
```

### 5.2 功能特性
1. **参数列表展示**: 表格形式展示所有参数
2. **搜索功能**: 支持按键名、命名空间搜索
3. **筛选功能**: 按命名空间筛选
4. **新增参数**: 弹窗表单添加新参数
5. **编辑参数**: 弹窗表单编辑参数值
6. **删除参数**: 确认后删除参数
7. **导入导出**: 支持JSON格式导入导出
8. **实时统计**: 显示参数总数和分类统计

### 5.3 界面元素
- **搜索框**: 实时搜索过滤
- **命名空间下拉**: 快速筛选
- **新增按钮**: 打开新增参数对话框
- **操作按钮**: 编辑、删除、复制
- **分页控件**: 支持大量参数分页显示
- **导入导出按钮**: JSON文件导入导出

## 六、实现细节

### 6.1 Plugin.cs 核心逻辑
```csharp
- 插件初始化
- 注册API路由
- 获取配置路径
- 插件生命周期管理
```

### 6.2 ParameterStorageService.cs 存储服务
```csharp
- 读取JSON文件
- 写入JSON文件
- 参数CRUD操作
- 文件锁机制（防止并发写入）
- 数据验证
- 异常处理
```

### 6.3 ParameterController.cs API控制器
```csharp
- 路由处理
- 请求验证
- 权限检查
- 调用存储服务
- 返回标准化响应
## 五、安全性考虑

### 5.1 Token验证机制
参考 emby-plugin-danmu 的实现方式，所有API请求必须携带有效的EMBY Token。

**验证方式**:
1. 通过查询参数传递: `?X-Emby-Token=xxx`
2. 通过HTTP Header传递: `X-Emby-Token: xxx`

**验证流程**:
```csharp
1. 从请求中获取Token (QueryString或Header)
2. 使用IAuthorizationContext验证Token有效性
3. 使用ISessionManager获取会话信息
4. 验证用户是否为管理员
5. 验证通过后执行业务逻辑
```

### 5.2 其他安全措施
1. **权限控制**: 仅管理员可访问API和管理界面
2. **输入验证**: 验证参数键名、值的合法性
3. **XSS防护**: 前端输出转义
4. **文件访问**: 限制只能访问指定目录
5. **并发控制**: 文件读写加锁
6. **日志记录**: 记录所有操作日志

## 六、Web管理界面设计

### 6.1 界面布局
```
+--------------------------------------------------+
|  参数持久化管理                                      |
+--------------------------------------------------+
|  [搜索框]  [命名空间筛选]  [+ 新增参数]              |
+--------------------------------------------------+
|  命名空间    |  键名    |  值    |  类型  |  操作   |
+--------------------------------------------------+
|  plugin.a   |  key1   | val1  | string | 编辑 删除|
|  plugin.a   |  key2   | val2  | number | 编辑 删除|
|  plugin.b   |  key3   | val3  | json   | 编辑 删除|
+--------------------------------------------------+
|  总计: 3 个参数                                     |
+--------------------------------------------------+
```

### 6.2 功能特性
1. **参数列表展示**: 表格形式展示所有参数
2. **搜索功能**: 支持按键名、命名空间搜索
3. **筛选功能**: 按命名空间筛选
4. **新增参数**: 弹窗表单添加新参数
5. **编辑参数**: 弹窗表单编辑参数值
6. **删除参数**: 确认后删除参数
7. **导入导出**: 支持JSON格式导入导出
8. **实时统计**: 显示参数总数和分类统计

## 七、实现细节

### 7.1 Plugin.cs 核心逻辑
- 插件初始化
- 注册API路由
- 获取配置路径
- 插件生命周期管理

### 7.2 ParameterStorageService.cs 存储服务
- 读取JSON文件
- 写入JSON文件
- 参数CRUD操作
- 文件锁机制（防止并发写入）
- 数据验证
- 异常处理

### 7.3 ParameterController.cs API控制器
- 路由处理
- 请求验证
- 权限检查
- Token验证
- 业务逻辑调用
- 响应格式化

## 八、使用场景

### 8.1 插件配置存储
其他EMBY插件可以使用本插件存储配置参数，避免自己实现存储逻辑。

### 8.2 跨插件数据共享
多个插件可以通过命名空间隔离，共享参数数据。

### 8.3 外部应用集成
外部应用可以通过API接口读写EMBY相关配置。

## 九、设计优势

### 9.1 接口设计优势
✅ **统一性** - 所有操作使用相同的设计模式
✅ **简洁性** - 接口数量精简，学习成本低
✅ **灵活性** - 单个和批量操作使用同一接口
✅ **可扩展性** - 易于添加新功能
✅ **易用性** - 不需要在多个接口间选择

### 9.2 开发体验优势
✅ **减少选择困难** - 每种操作只有一个接口
✅ **统一的错误处理** - 所有接口返回格式一致
✅ **更好的语义化** - 接口路径清晰表达功能
✅ **减少维护成本** - 更少的代码和接口

### 9.3 性能优势
✅ **批量操作优化** - 减少网络请求次数
✅ **统一的验证逻辑** - 提高处理效率
✅ **更少的路由匹配** - 提升响应速度

## 十、总结

本插件提供了一个简单易用的参数持久化解决方案，采用统一的API设计理念。

**核心特性**:
- ✅ 5个统一设计的API接口
- ✅ 自动识别单个/批量操作
- ✅ 命名空间分类管理
- ✅ Web可视化管理界面
- ✅ Token安全验证
- ✅ 导入导出功能

**适用场景**:
- EMBY插件开发者存储配置
- 跨插件数据共享
- 外部应用集成

**设计原则**:
- 统一设计 - 所有接口采用相同的设计模式
- 自动识别 - 通过请求体结构自动判断操作类型
- 语义清晰 - 接口路径明确表达功能
- 简化使用 - 减少接口数量，降低学习成本
